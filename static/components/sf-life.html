<link rel="import" href="../bower_components/polymer/polymer.html">

<polymer-element name="sf-life" attributes="">
    <template>
        <link rel="import" href="../bower_components/paper-toggle-button/paper-toggle-button.html">
        <link rel="import" href="../bower_components/core-drawer-panel/core-drawer-panel.html">
        <link rel="stylesheet" href="../bower_components/bootstrap/dist/css/bootstrap.min.css">
        <script src="../bower_components/bootstrap/dist/js/bootstrap.min.js"></script>
        <script src="../js/vanilla.js"></script>
        <script src="../js/jquery.min.js"></script>
        <script src="../js/spin.min.js"></script>
        <style>
        .left-panel {
            background-color: #45DFBE;
            height: 100%;
            padding: 50px;
        }
        .right-panel {
            background-color: #FFFFFF;
            height: 100%;
        }
        .option-tab {
        }

        #tooltip {   
            position: absolute;           
            text-align: center;
            padding: 20px;           
            margin: 10px;
            font: 12px sans-serif;        
            background: lightsteelblue;   
            border: 1px;      
            border-radius: 2px;           
            pointer-events: none;         
        }
        #tooltip h4{
            margin:0;
            font-size:14px;
        }
        #tooltip {
            background:white;
            border:1px solid grey;
            border-radius:5px;
            font-size:12px;
            width:auto;
            padding:4px;
            padding-top: 6px;
            color:white;
            opacity:0;
        }
        #tooltip table{
            table-layout:fixed;
        }
        #tooltip tr td{
            padding:0;
            margin:0;
        }
        #tooltip tr td:nth-child(1){
            width:50px;
        }
        #tooltip tr td:nth-child(2){
            text-align:center;
        }
        .spinner {
            background-color: #000;
        }
    </style>
    <div id="contain" class="top-section">
    <div class="row">
      <div class="col-md-4 left-panel">
        <div center horizontal layout>
            <div flex><h2>EDGE</h2></div>
        </div>
        </br>
        <template repeat="{{ feature in features }}">
            <div center horizontal layout class="option-tab">
                <div flex> {{feature[0]}} </div>
                <paper-toggle-button id="{{feature[0]}}" role="button" aria-checked="false" on-core-change="{{featureToggled}}"></paper-toggle-button>
            </div> 
        </template>
      </div>
      <div class="col-md-8 right-panel">
          <div id="map" style="width: 100%; height: 100%"></div>
      </div>
      <div id="tooltip"></div><!-- div to hold tooltip. -->

    </div>
    </div>
    </template>
    <script src="../js/d3.v2.min.js"></script>
    <script src="../bower_components/require/build/require.min.js"></script>
    <script src="../bower_components/underscore/underscore-min.js" type="text/javascript"></script>
    <script>
        var $j = jQuery.noConflict();
        Polymer('sf-life', {
            metricData: null,
            features: [],
            scores: {},
            computedScores: {},
            total: 0,
            ready: function() {
                var r = new XMLHttpRequest();
                var that = this;
                r.open("GET", "static/data/SF.json", true);
                r.onreadystatechange = function () {
                  if (r.readyState != 4 || r.status != 200) return;
                  metricData = JSON.parse(r.responseText);
                  console.dir(metricData.format);
                  _.each(metricData.format, function(feature){
                    that.features.push([feature, false]);
                  })
                  console.dir(metricData.data)
                  _.map(metricData.data, function(num, key){
                    that.scores[key] = num;
                  });
                  console.dir(that.scores);
                };
                r.send("na");
                var draw = function() {
                    if (that.$.map.querySelector('svg') != undefined) {
                        that.$.map.querySelector('svg').remove();
                    }
                    var arr = [];
                    var rates = [];
                    var width = that.$.map.offsetWidth;
                    var height = that.$.map.offsetHeight;

                    //var scale = width * 354;
                    var scale = (width/843)*268000;
                    var horizontalOffset = width / 1.7;
                    var verticalOffset = height / 3.05;

                    var map = d3.select(that.$.map).append('svg').attr("width", width)
                    .attr("height", height);
                    var path = d3.geo.path().projection(d3.geo.albers().origin([-122.4031949051393, 37.80511854740679]).scale(scale).translate([horizontalOffset, verticalOffset]));
                    d3.json('static/data/AsthmaRates_CB00.json', function(json) {
                        map.selectAll('path')
                            .data(json.features)
                            .enter().append('path')
                            .attr('d', path)
                            .attr("id", function(d, i){ /*console.log(i);*/ return 'n' + i })
                            .attr('class', function(d, i) {
                                //console.log('block: ' + d.properties.BLOCKGROUP);
                                //   console.log('zip z' + d.properties);
                                arr.push(d.properties);
                                return 'block b' + d.properties.BLOCKGROUP // + 'num id' + i
                            })
                            .style("fill", function(d, i){ /*console.log(i);*/ return 'n' + i })
                            .on('mouseover', function() {
                                var zip = d3.select(this).attr('class').split('block b').join('');
                                var ques = d3.select(this).attr('id').split('n').join('');
                                var score = Math.round(that.calculateScore(zip) * 100) / 10;
                                console.log('block ' + zip + ' selected with id ' + ques + ' with score ' + score + ' and total ' + that.total);

                                d3.select(that.$.map).selectAll('p').text('');
                                for (key in arr) {
                                    d3.select(that.$.map.querySelector('.b' + arr[key].BLOCKGROUP)).style("fill", "black");
                                }
                                d3.select(that.$.map.querySelector('.b' + zip)).style("fill", "purple");

                                // Add tooltip
                                d3.select(that.$.tooltip).transition().duration(200).style("opacity", .9);

                                var tootipContent =                     
                                    "<table>"+
                                    "<tr><td>Score</td><td>"+(score)+"</td></tr>"+
                                    "</table>";

                                d3.select(that.$.tooltip).html(tootipContent)  
                                    .style("left", (d3.event.pageX) + "px")     
                                    .style("top", (d3.event.pageY - 28) + "px");
                            })
                            .on('mouseout', function() {
                                // Remove tooltip on mouse out
                                d3.select(that.$.tooltip).transition().duration(500).style("opacity", 0);

                                // Deselect block on mouse out
                                for (key in arr) {
                                    d3.select(that.$.map.querySelector('.b' + arr[key].BLOCKGROUP)).style("fill", "black");
                                }
                            });
                    }); 
                }
                draw();
                $j(window).resize(function() {
                    if(this.resizeTO) clearTimeout(this.resizeTO);
                    this.resizeTO = setTimeout(function() {
                        $j(this).trigger('resizeEnd');
                    }, 500);
                });

                $j(window).bind('resizeEnd', function() {
                    draw();
                });

            },
            calculateScore: function(district_id) {
                console.log("calculating score");
                score = 0.0;
                feature_scores = this.scores[district_id];
                console.dir(feature_scores);
                for (var i = 0; i < feature_scores.length; i++) {
                    if (this.features[i][1]) {
                        score += feature_scores[i];
                    }
                }
                if (this.total > 0){
                    score = score/this.total;
                } else {
                    score = 0.0;
                }
                return score;
            },
            updateTotal: function() {
                console.log("updating total");
                sum = 0;
                _.each(this.features, function(feature){
                    console.log(feature);
                    if (feature[1] == true){
                        sum++;
                    }
                })
                this.total = sum;
                this.calculateScore("060750167002");
            },
            featuresChanged: function(oldValue) {
                this.updateTotal();
            },
            featureToggled: function(obj) {
                var index = -1;
                var that = this;
                _.each(this.features, function(feature){
                    if (feature[0] == obj.target.id){
                        feature[1] = !feature[1];
                    }
                })
                // var target = that.$.contain;
                // var opts = {
                //   lines: 13, // The number of lines to draw
                //   length: 20, // The length of each line
                //   width: 10, // The line thickness
                //   radius: 30, // The radius of the inner circle
                //   corners: 1, // Corner roundness (0..1)
                //   rotate: 0, // The rotation offset
                //   direction: 1, // 1: clockwise, -1: counterclockwise
                //   color: '#000', // #rgb or #rrggbb or array of colors
                //   speed: 1, // Rounds per second
                //   trail: 60, // Afterglow percentage
                //   shadow: true, // Whether to render a shadow
                //   hwaccel: false, // Whether to use hardware acceleration
                //   className: 'spinner', // The CSS class to assign to the spinner
                //   zIndex: 2e9, // The z-index (defaults to 2000000000)
                //   top: '50%', // Top position relative to parent
                //   left: '50%' // Left position relative to parent
                // };
                // var spinner = new Spinner(opts).spin(target);
                _.map(metricData.data, function(num, key){
                    that.computedScores[key] = that.calculateScore(key);
                });
                // spinner.stop();
                this.updateTotal();
                console.dir(that.computedScores);
            }
        });
    </script>
    
</polymer-element>